# Supabase Mocking Implementation Plan

**Goal:** Implement cy.intercept() mocking for fast, isolated Cypress testing without requiring a test Supabase instance.

**Status:** ðŸŸ¢ COMPLETE
**Estimated Total Time:** 3-4 hours
**Last Updated:** 2025-10-01

---

## ðŸ“‹ Overview

This plan implements **Option 2: cy.intercept() Mocking** for Cypress tests. This approach:

- âœ… **Fast** - No network calls to external services
- âœ… **Isolated** - No test database required
- âœ… **Flexible** - Easy to simulate error states
- âœ… **Portable** - Works offline, no backend setup needed

### What You'll Build

1. Mock Supabase auth commands (`cy.mockSupabaseAuth()`)
2. Mock database responses (`cy.mockSupabaseDatabase()`)
3. Error state simulation (`cy.mockSupabaseError()`)
4. Test data fixtures (users, projects, elements)
5. Comprehensive testing guide

---

## Phase 1: Mock Auth Commands (1 hour) âœ… COMPLETE

### âœ… Task 1.1: Create Mock Auth Commands

**Status:** âœ… Complete

**Create `cypress/support/commands/mock-supabase.ts`:**

```typescript
/// <reference types="cypress" />

/**
 * Mock Supabase authentication with cy.intercept()
 * Fast, isolated auth for UI and integration testing
 */

/**
 * Mock Supabase auth endpoints
 */
Cypress.Commands.add(
  'mockSupabaseAuth',
  (user?: {
    id?: string;
    email?: string;
    username?: string;
    display_name?: string;
  }) => {
    const mockUser = {
      id: user?.id || `mock-user-${Date.now()}`,
      email: user?.email || 'mock@example.com',
      email_confirmed_at: new Date().toISOString(),
      created_at: new Date().toISOString(),
      user_metadata: {
        username: user?.username || 'mockuser',
        display_name: user?.display_name || 'Mock User',
      },
    };

    cy.log('ðŸŽ­ Mocking Supabase auth for:', mockUser.email);

    // Mock login endpoint (POST /auth/v1/token)
    cy.intercept('POST', '**/auth/v1/token*', {
      statusCode: 200,
      body: {
        access_token: `mock-jwt-token-${Date.now()}`,
        token_type: 'bearer',
        expires_in: 3600,
        expires_at: Math.floor(Date.now() / 1000) + 3600,
        refresh_token: 'mock-refresh-token',
        user: mockUser,
      },
    }).as('mockAuthLogin');

    // Mock get user endpoint (GET /auth/v1/user)
    cy.intercept('GET', '**/auth/v1/user', {
      statusCode: 200,
      body: { user: mockUser },
    }).as('mockGetUser');

    // Mock signup endpoint (POST /auth/v1/signup)
    cy.intercept('POST', '**/auth/v1/signup', {
      statusCode: 200,
      body: {
        user: mockUser,
        session: {
          access_token: `mock-jwt-token-${Date.now()}`,
          token_type: 'bearer',
          expires_in: 3600,
          refresh_token: 'mock-refresh-token',
        },
      },
    }).as('mockSignup');

    // Mock logout endpoint (POST /auth/v1/logout)
    cy.intercept('POST', '**/auth/v1/logout', {
      statusCode: 204,
    }).as('mockLogout');

    // Mock password reset (POST /auth/v1/recover)
    cy.intercept('POST', '**/auth/v1/recover', {
      statusCode: 200,
    }).as('mockPasswordReset');

    // Set localStorage auth state (mimics Supabase client behavior)
    cy.window().then(win => {
      const authKey = 'sb-mock-auth-token';
      win.localStorage.setItem(
        authKey,
        JSON.stringify({
          access_token: `mock-jwt-token-${Date.now()}`,
          token_type: 'bearer',
          expires_at: Math.floor(Date.now() / 1000) + 3600,
          expires_in: 3600,
          refresh_token: 'mock-refresh-token',
          user: mockUser,
        }),
      );
    });

    cy.log('âœ… Supabase auth mocked');
  },
);

/**
 * Clean mock auth state
 */
Cypress.Commands.add('cleanMockAuth', () => {
  cy.window().then(win => {
    win.localStorage.clear();
    cy.log('ðŸ§¹ Mock auth state cleaned');
  });
});

export {};
```

**Update `cypress/support/commands/index.ts`:**

```typescript
// Add to existing imports
import './mock-supabase';
```

**Add TypeScript definitions in `cypress/support/index.d.ts`:**

```typescript
declare global {
  namespace Cypress {
    interface Chainable {
      // Mock Supabase Auth
      mockSupabaseAuth(user?: {
        id?: string;
        email?: string;
        username?: string;
        display_name?: string;
      }): Chainable<void>;
      cleanMockAuth(): Chainable<void>;
    }
  }
}
```

**Output:**

- âœ… `cy.mockSupabaseAuth()` command created
- âœ… All auth endpoints mocked
- âœ… TypeScript types defined

**Validation:**

```bash
# Test the command
npm run cypress:open
# Create a quick test file and run:
it('should mock auth', () => {
  cy.mockSupabaseAuth({ email: 'test@mock.com' });
  cy.visit('/login');
  // Check that auth token exists in localStorage
  cy.window().then(win => {
    const authToken = win.localStorage.getItem('sb-mock-auth-token');
    expect(authToken).to.not.be.null;
  });
});
```

---

## Phase 2: Mock Database Commands (1 hour) âœ… COMPLETE

### âœ… Task 2.1: Create Database Mocking Commands

**Status:** âœ… Complete (Already implemented in Phase 1)

**Add to `cypress/support/commands/mock-supabase.ts`:**

```typescript
/**
 * Mock Supabase database endpoints
 */
Cypress.Commands.add(
  'mockSupabaseDatabase',
  (fixtures?: { profiles?: any[]; projects?: any[]; elements?: any[] }) => {
    cy.log('ðŸŽ­ Mocking Supabase database');

    // Mock profiles endpoint (GET /rest/v1/profiles)
    if (fixtures?.profiles !== undefined) {
      cy.intercept('GET', '**/rest/v1/profiles*', {
        statusCode: 200,
        body: fixtures.profiles,
        headers: {
          'Content-Range': `0-${fixtures.profiles.length - 1}/${
            fixtures.profiles.length
          }`,
        },
      }).as('mockGetProfiles');

      // Mock profile creation (POST /rest/v1/profiles)
      cy.intercept('POST', '**/rest/v1/profiles', req => {
        req.reply({
          statusCode: 201,
          body: [{ ...req.body, id: req.body.id || `profile-${Date.now()}` }],
        });
      }).as('mockCreateProfile');

      // Mock profile update (PATCH /rest/v1/profiles)
      cy.intercept('PATCH', '**/rest/v1/profiles*', req => {
        req.reply({
          statusCode: 200,
          body: [{ ...req.body }],
        });
      }).as('mockUpdateProfile');
    }

    // Mock projects endpoint (GET /rest/v1/projects)
    if (fixtures?.projects !== undefined) {
      cy.intercept('GET', '**/rest/v1/projects*', {
        statusCode: 200,
        body: fixtures.projects,
        headers: {
          'Content-Range': `0-${fixtures.projects.length - 1}/${
            fixtures.projects.length
          }`,
        },
      }).as('mockGetProjects');

      // Mock project creation (POST /rest/v1/projects)
      cy.intercept('POST', '**/rest/v1/projects', req => {
        req.reply({
          statusCode: 201,
          body: [
            {
              ...req.body,
              id: `project-${Date.now()}`,
              created_at: new Date().toISOString(),
            },
          ],
        });
      }).as('mockCreateProject');

      // Mock project update (PATCH /rest/v1/projects)
      cy.intercept('PATCH', '**/rest/v1/projects*', req => {
        req.reply({
          statusCode: 200,
          body: [{ ...req.body, updated_at: new Date().toISOString() }],
        });
      }).as('mockUpdateProject');

      // Mock project delete (DELETE /rest/v1/projects)
      cy.intercept('DELETE', '**/rest/v1/projects*', {
        statusCode: 204,
      }).as('mockDeleteProject');
    }

    // Mock elements endpoint (GET /rest/v1/world_elements)
    if (fixtures?.elements !== undefined) {
      cy.intercept('GET', '**/rest/v1/world_elements*', {
        statusCode: 200,
        body: fixtures.elements,
        headers: {
          'Content-Range': `0-${fixtures.elements.length - 1}/${
            fixtures.elements.length
          }`,
        },
      }).as('mockGetElements');

      // Mock element creation (POST /rest/v1/world_elements)
      cy.intercept('POST', '**/rest/v1/world_elements', req => {
        req.reply({
          statusCode: 201,
          body: [
            {
              ...req.body,
              id: `element-${Date.now()}`,
              created_at: new Date().toISOString(),
            },
          ],
        });
      }).as('mockCreateElement');

      // Mock element update (PATCH /rest/v1/world_elements)
      cy.intercept('PATCH', '**/rest/v1/world_elements*', req => {
        req.reply({
          statusCode: 200,
          body: [{ ...req.body, updated_at: new Date().toISOString() }],
        });
      }).as('mockUpdateElement');

      // Mock element delete (DELETE /rest/v1/world_elements)
      cy.intercept('DELETE', '**/rest/v1/world_elements*', {
        statusCode: 204,
      }).as('mockDeleteElement');
    }

    cy.log('âœ… Supabase database mocked');
  },
);

/**
 * Mock Supabase error responses
 * Use for testing error states
 */
Cypress.Commands.add(
  'mockSupabaseError',
  (
    endpoint: string,
    errorType: 'auth' | 'network' | 'validation' | 'notFound',
  ) => {
    const errors = {
      auth: {
        statusCode: 401,
        body: {
          error: 'invalid_credentials',
          error_description: 'Invalid login credentials',
          message: 'Invalid login credentials',
        },
      },
      network: {
        statusCode: 500,
        body: {
          error: 'server_error',
          error_description: 'Internal server error',
          message: 'An unexpected error occurred',
        },
      },
      validation: {
        statusCode: 400,
        body: {
          error: 'validation_error',
          error_description: 'Invalid request parameters',
          message: 'Validation failed',
        },
      },
      notFound: {
        statusCode: 404,
        body: {
          error: 'not_found',
          error_description: 'Resource not found',
          message: 'The requested resource does not exist',
        },
      },
    };

    cy.intercept('*', endpoint, errors[errorType]).as(`mockError-${errorType}`);
    cy.log(`ðŸŽ­ Mocking ${errorType} error for:`, endpoint);
  },
);
```

**Update TypeScript definitions:**

```typescript
declare global {
  namespace Cypress {
    interface Chainable {
      // Mock Supabase Database
      mockSupabaseDatabase(fixtures?: {
        profiles?: any[];
        projects?: any[];
        elements?: any[];
      }): Chainable<void>;
      mockSupabaseError(
        endpoint: string,
        errorType: 'auth' | 'network' | 'validation' | 'notFound',
      ): Chainable<void>;
    }
  }
}
```

**Output:**

- âœ… Database mocking commands
- âœ… CRUD operations mocked (GET, POST, PATCH, DELETE)
- âœ… Error state mocking

**Validation:**

```bash
it('should mock database', () => {
  cy.mockSupabaseAuth();
  cy.mockSupabaseDatabase({
    projects: [{ id: '1', name: 'Test Project' }]
  });
  cy.visit('/projects');
  cy.wait('@mockGetProjects');
  cy.get('[data-cy="projects-list"]').should('contain', 'Test Project');
});
```

---

## Phase 3: Test Fixtures (30 minutes) âœ… COMPLETE

### âœ… Task 3.1: Create Test Data Fixtures

**Status:** âœ… Complete

**Create `cypress/fixtures/mock-users.json`:**

```json
{
  "testUser": {
    "id": "mock-user-001",
    "email": "test@fantasyapp.com",
    "username": "testuser",
    "display_name": "Test User"
  },
  "adminUser": {
    "id": "mock-user-002",
    "email": "admin@fantasyapp.com",
    "username": "adminuser",
    "display_name": "Admin User"
  }
}
```

**Create `cypress/fixtures/mock-profiles.json`:**

```json
[
  {
    "id": "mock-user-001",
    "username": "testuser",
    "display_name": "Test User",
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
]
```

**Create `cypress/fixtures/mock-projects.json`:**

```json
[
  {
    "id": "project-001",
    "user_id": "mock-user-001",
    "name": "Test Fantasy World",
    "description": "A test world for Cypress tests",
    "is_public": false,
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  },
  {
    "id": "project-002",
    "user_id": "mock-user-001",
    "name": "Dragon Realm",
    "description": "A world filled with dragons",
    "is_public": true,
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
]
```

**Create `cypress/fixtures/mock-elements.json`:**

```json
[
  {
    "id": "element-001",
    "project_id": "project-001",
    "category": "character",
    "name": "Aria Stormwind",
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  },
  {
    "id": "element-002",
    "project_id": "project-001",
    "category": "location",
    "name": "Castle Evernight",
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  },
  {
    "id": "element-003",
    "project_id": "project-002",
    "category": "creature",
    "name": "Elder Dragon",
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-01T00:00:00Z"
  }
]
```

**Output:**

- âœ… Fixtures for users, profiles, projects, elements
- âœ… Consistent mock IDs for relationships

**Usage in tests:**

```typescript
beforeEach(() => {
  cy.fixture('mock-users').then(users => {
    cy.mockSupabaseAuth(users.testUser);
  });

  cy.fixture('mock-projects').then(projects => {
    cy.mockSupabaseDatabase({ projects });
  });

  cy.visit('/dashboard');
});
```

---

## Phase 4: Example Test Implementations (30 minutes) âœ… COMPLETE

### âœ… Task 4.1: Create Example Tests

**Status:** âœ… Complete

**Create `cypress/e2e/examples/mock-auth-example.cy.ts`:**

```typescript
/// <reference types="cypress" />

describe('Mock Auth Example', () => {
  beforeEach(function () {
    cy.comprehensiveDebug();
    cy.cleanMockAuth();
  });

  it('should authenticate with mocked Supabase', () => {
    cy.mockSupabaseAuth({
      email: 'example@test.com',
      username: 'exampleuser',
    });

    cy.visit('/login');

    // Simulate login form submission
    cy.get('[data-cy="email-input"]').type('example@test.com');
    cy.get('[data-cy="password-input"]').type('password123');
    cy.get('[data-cy="submit-button"]').click();

    // Wait for mock login
    cy.wait('@mockAuthLogin');

    // Should redirect to dashboard
    cy.url().should('include', '/dashboard');
  });

  it('should handle login error states', () => {
    // Mock auth error
    cy.mockSupabaseError('**/auth/v1/token*', 'auth');

    cy.visit('/login');
    cy.get('[data-cy="email-input"]').type('wrong@example.com');
    cy.get('[data-cy="password-input"]').type('wrongpassword');
    cy.get('[data-cy="submit-button"]').click();

    cy.wait('@mockError-auth');

    // Should show error message
    cy.get('[data-cy="error-message"]').should('be.visible');
    cy.get('[data-cy="error-message"]').should('contain', 'Invalid');
  });

  it('should mock database with fixtures', () => {
    cy.mockSupabaseAuth();

    // Load fixtures
    cy.fixture('mock-projects').then(projects => {
      cy.mockSupabaseDatabase({ projects });
    });

    cy.visit('/projects');

    // Wait for mock data load
    cy.wait('@mockGetProjects');

    // Verify projects displayed
    cy.get('[data-cy="projects-list"]').should('contain', 'Test Fantasy World');
    cy.get('[data-cy="projects-list"]').should('contain', 'Dragon Realm');
  });

  it('should mock project creation', () => {
    cy.mockSupabaseAuth();
    cy.mockSupabaseDatabase({ projects: [] });

    cy.visit('/projects');

    // Create new project
    cy.get('[data-cy="new-project-button"]').click();
    cy.get('[data-cy="project-name-input"]').type('New Mocked Project');
    cy.get('[data-cy="project-description-input"]').type('Created via mock');
    cy.get('[data-cy="save-project-button"]').click();

    // Wait for mock creation
    cy.wait('@mockCreateProject');

    // Should show success message
    cy.get('[data-cy="success-message"]').should('be.visible');
  });
});
```

**Output:**

- âœ… Complete working examples
- âœ… Auth, database, and error mocking demonstrated

---

## Phase 5: Documentation (30 minutes) âœ… COMPLETE

### âœ… Task 5.1: Create Testing Guide

**Status:** âœ… Complete

**Create `cypress/docs/MOCK-SUPABASE-GUIDE.md`:**

```markdown
# Mock Supabase Testing Guide

## Overview

This project uses `cy.intercept()` to mock Supabase auth and database operations for fast, isolated Cypress testing.

## Quick Start

### Basic Auth Mocking

\`\`\`typescript
beforeEach(() => {
cy.mockSupabaseAuth();
cy.visit('/dashboard');
});
\`\`\`

### Auth with Custom User

\`\`\`typescript
beforeEach(() => {
cy.mockSupabaseAuth({
email: 'custom@example.com',
username: 'customuser',
display_name: 'Custom User',
});
cy.visit('/dashboard');
});
\`\`\`

### Database Mocking with Fixtures

\`\`\`typescript
beforeEach(() => {
cy.mockSupabaseAuth();

cy.fixture('mock-projects').then((projects) => {
cy.mockSupabaseDatabase({ projects });
});

cy.visit('/projects');
cy.wait('@mockGetProjects');
});
\`\`\`

### Error State Testing

\`\`\`typescript
it('should handle auth errors', () => {
cy.mockSupabaseError('\*_/auth/v1/token_', 'auth');
cy.visit('/login');
// ... submit form
cy.wait('@mockError-auth');
cy.get('[data-cy="error-message"]').should('be.visible');
});
\`\`\`

## Available Commands

### cy.mockSupabaseAuth(user?)

Mocks Supabase authentication endpoints.

**Parameters:**

- user.id - Mock user ID (default: auto-generated)
- user.email - Mock email (default: 'mock@example.com')
- user.username - Mock username (default: 'mockuser')
- user.display_name - Mock display name (default: 'Mock User')

**Intercepted Endpoints:**

- POST /auth/v1/token - Login
- GET /auth/v1/user - Get user
- POST /auth/v1/signup - Signup
- POST /auth/v1/logout - Logout
- POST /auth/v1/recover - Password reset

### cy.mockSupabaseDatabase(fixtures)

Mocks Supabase database endpoints.

**Parameters:**

- fixtures.profiles - Array of profile objects
- fixtures.projects - Array of project objects
- fixtures.elements - Array of element objects

**Intercepted Endpoints (per table):**

- GET /rest/v1/[table] - List items
- POST /rest/v1/[table] - Create item
- PATCH /rest/v1/[table] - Update item
- DELETE /rest/v1/[table] - Delete item

### cy.mockSupabaseError(endpoint, errorType)

Mocks error responses for testing error states.

**Parameters:**

- endpoint - URL pattern to intercept
- errorType - Type of error: 'auth' | 'network' | 'validation' | 'notFound'

**Error Types:**

- auth - 401 Invalid credentials
- network - 500 Server error
- validation - 400 Validation error
- notFound - 404 Not found

### cy.cleanMockAuth()

Clears all mock auth state from localStorage.

## Test Patterns

### Full Integration Test

\`\`\`typescript
describe('Project Workflow', () => {
beforeEach(() => {
// Setup auth and data
cy.mockSupabaseAuth({ email: 'workflow@test.com' });
cy.fixture('mock-projects').then((projects) => {
cy.mockSupabaseDatabase({ projects });
});
});

it('should create, edit, and delete project', () => {
cy.visit('/projects');
cy.wait('@mockGetProjects');

    // Create
    cy.get('[data-cy="new-project-button"]').click();
    cy.get('[data-cy="project-name-input"]').type('New Project');
    cy.get('[data-cy="save-project-button"]').click();
    cy.wait('@mockCreateProject');

    // Edit
    cy.get('[data-cy="edit-project-button"]').first().click();
    cy.get('[data-cy="project-name-input"]').clear().type('Updated Project');
    cy.get('[data-cy="save-project-button"]').click();
    cy.wait('@mockUpdateProject');

    // Delete
    cy.get('[data-cy="delete-project-button"]').first().click();
    cy.get('[data-cy="confirm-delete-button"]').click();
    cy.wait('@mockDeleteProject');

});
});
\`\`\`

### Error State Testing

\`\`\`typescript
describe('Error Handling', () => {
it('should handle network errors', () => {
cy.mockSupabaseAuth();
cy.mockSupabaseError('\*_/rest/v1/projects_', 'network');

    cy.visit('/projects');
    cy.wait('@mockError-network');

    cy.get('[data-cy="error-message"]').should('contain', 'server error');

});

it('should handle validation errors', () => {
cy.mockSupabaseAuth();
cy.mockSupabaseDatabase({ projects: [] });
cy.mockSupabaseError('\*\*/rest/v1/projects', 'validation');

    cy.visit('/projects/new');
    cy.get('[data-cy="save-project-button"]').click();
    cy.wait('@mockError-validation');

    cy.get('[data-cy="validation-error"]').should('be.visible');

});
});
\`\`\`

## Benefits of Mocking

âœ… **Fast** - No network calls, tests run 10-100x faster
âœ… **Isolated** - No external dependencies, tests always work
âœ… **Flexible** - Easy to test edge cases and error states
âœ… **Portable** - Works offline, no backend setup needed
âœ… **Deterministic** - Same results every time

## Tips & Best Practices

1. **Always clean before tests:**
   \`\`\`typescript
   beforeEach(() => {
   cy.cleanMockAuth(); // Start fresh
   });
   \`\`\`

2. **Wait for intercepts:**
   \`\`\`typescript
   cy.wait('@mockGetProjects'); // Ensures data loaded
   \`\`\`

3. **Use fixtures for complex data:**
   \`\`\`typescript
   cy.fixture('mock-projects').then(projects => {
   cy.mockSupabaseDatabase({ projects });
   });
   \`\`\`

4. **Test error states:**
   \`\`\`typescript
   cy.mockSupabaseError('\*_/auth/v1/token_', 'auth');
   \`\`\`

5. **Mock before visit:**
   \`\`\`typescript
   cy.mockSupabaseAuth(); // Setup mocks first
   cy.visit('/page'); // Then navigate
   \`\`\`

## Examples

See cypress/e2e/examples/mock-auth-example.cy.ts for complete working examples.

## Troubleshooting

**Issue:** "Mock not intercepting"

- **Fix:** Ensure cy.mockSupabaseAuth() is called **before** cy.visit()

**Issue:** "Data not loading"

- **Fix:** Add cy.wait('@mockGetProjects') after navigation

**Issue:** "Auth token not found"

- **Fix:** Check that cy.mockSupabaseAuth() sets localStorage correctly

**Issue:** "Tests flaky"

- **Fix:** Always use cy.wait() for intercepts, don't rely on timeouts
```

**Output:**

- âœ… Comprehensive testing guide
- âœ… All commands documented
- âœ… Examples and troubleshooting

---

## ðŸŽ¯ Success Criteria

- [x] `cy.mockSupabaseAuth()` command works âœ…
- [x] `cy.mockSupabaseDatabase()` command works âœ…
- [x] `cy.mockSupabaseError()` command works âœ…
- [x] Test fixtures created âœ…
- [x] Example tests created âœ…
- [x] Documentation complete âœ…

**ALL CRITERIA MET! ðŸŽ‰**

---

## ðŸ“Š Progress Tracking

**Current Phase:** Implementation

- [x] Phase 1: Mock Auth Commands (1/1 tasks) âœ… COMPLETE
- [x] Phase 2: Mock Database Commands (1/1 tasks) âœ… COMPLETE
- [x] Phase 3: Test Fixtures (1/1 tasks) âœ… COMPLETE
- [x] Phase 4: Example Tests (1/1 tasks) âœ… COMPLETE
- [x] Phase 5: Documentation (1/1 tasks) âœ… COMPLETE

**Overall Progress:** 5/5 tasks (100%) ðŸŽ‰

---

## ðŸš€ Next Steps

1. Start with **Phase 1, Task 1.1** - Create Mock Auth Commands
2. Test with `npm run cypress:open`
3. Proceed through phases sequentially
4. Use example tests to validate each phase

---

**Estimated completion:** 3-4 hours total
