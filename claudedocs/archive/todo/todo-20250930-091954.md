# TODO: Fix Build and Test Execution Issues

## ‚úÖ UPDATE: Critical Build Issues RESOLVED (2025-09-29)

**Summary of Fixes Applied:**

- Fixed duplicate `minify` configuration in vite.config.js
- Removed `@react-navigation/stack` from optimizeDeps (not installed)
- Removed `react-native-dotenv` from babel plugins (not needed)
- Added babel configuration to handle React Native Flow type syntax
- Created empty module aliases for mobile-only packages
- Fixed worker.plugins to be a function
- Created missing react-native-web-polyfills file

**Current Status:**

- ‚úÖ Vite dev server starts successfully on port 3002
- ‚úÖ Server remains stable and responds to requests
- ‚úÖ Cypress can connect and run tests
- ‚ö†Ô∏è Test elements not found (separate UI issue, not build issue)

## üö® Critical Issues (Blocking Test Execution)

### 1. Fix Vite Configuration Duplicate Keys

**File:** `vite.config.js`
**Issue:** Duplicate 'minify' key causing configuration conflicts
**Fix Required:**

- [x] Remove duplicate `minify: true` on line 224
- [x] Keep `minify: 'terser'` on line 146 since terserOptions are configured
      **Impact:** Build warnings and potential minification issues

### 2. Remove or Install Missing Navigation Dependency

**File:** `vite.config.js` and `package.json`
**Issue:** `@react-navigation/stack` is in optimizeDeps but not installed
**Fix Options:**

- [x] Option A: Remove `'@react-navigation/stack'` from line 241 in vite.config.js if not needed
- [ ] Option B: Install the package if actually needed: `npm install @react-navigation/stack`
      **Impact:** Dependency resolution failure during build

### 3. Fix React Native Flow Type Syntax Issues

**File:** `node_modules/react-native/index.js` (indirect)
**Issue:** Vite/esbuild cannot parse Flow type syntax `import typeof`
**Fix Required:**

- [x] Add esbuild loader configuration to handle Flow syntax
- [x] OR add React Native to transformIgnorePatterns
- [x] OR use a babel transform to strip Flow types
      **Suggested vite.config.js addition:**

```javascript
esbuild: {
  loader: 'jsx',
  include: /.*\.js$/,
  exclude: [],
}
```

**Impact:** Build fails completely, preventing server startup

## ‚ö†Ô∏è Important Issues (Build Warnings)

### 4. Update Vite Configuration for Latest API

**File:** `vite.config.js`
**Issues:**

- CJS build of Vite's Node API is deprecated
- worker.plugins should return an array
  **Fix Required:**
- [x] Update to use ESM imports for Vite config
- [x] Update worker.plugins to be a function returning array
      **Impact:** Deprecation warnings, may break in future Vite versions

### 5. Address Phantom Dependency Warnings

**Issue:** Vite reports missing dependencies that aren't actually imported
**Dependencies falsely reported as missing:**

- `react-native-document-picker`
- `react-native-fs`
- `react-native-share`
  **Root Cause:** These are mobile-only packages not used in web build
  **Fix Options:**
- [x] Add alias configuration to resolve these to empty modules for web
- [ ] OR add them to optimizeDeps.exclude
- [ ] OR investigate why Vite thinks they're imported
      **Suggested vite.config.js addition:**

```javascript
resolve: {
  alias: {
    'react-native-document-picker': path.resolve(__dirname, './src/utils/empty-module.js'),
    'react-native-fs': path.resolve(__dirname, './src/utils/empty-module.js'),
    'react-native-share': path.resolve(__dirname, './src/utils/empty-module.js'),
  }
}
```

### 6. Missing react-native-dotenv Package

**Issue:** Babel configuration expects react-native-dotenv
**Fix Options:**

- [ ] Option A: Install if environment variables are needed: `npm install react-native-dotenv`
- [x] Option B: Remove references from babel configuration if not needed
- [ ] Option C: Use Vite's built-in env variable handling instead
      **Impact:** Transform errors during build

## üìã Recommended Fix Order

1. **First Priority - Get Server Running:**

   - Fix duplicate minify key (item #1)
   - Fix or remove @react-navigation/stack (item #2)
   - Handle React Native Flow syntax (item #3)

2. **Second Priority - Clean Build:**

   - Address phantom dependencies (item #5)
   - Fix react-native-dotenv issue (item #6)

3. **Third Priority - Future-Proofing:**
   - Update to latest Vite API patterns (item #4)

## üß™ Verification Steps After Fixes

1. Run `npm run web` and verify server starts on port 3002
2. Check that http://localhost:3002 loads without errors
3. Run `npm run cypress:run -- --spec cypress/e2e/verify-login-page.cy.ts`
4. Verify test executes and can access the application
5. Check browser console for any remaining errors

## üìù Notes

- The test itself (`verify-login-page.cy.ts`) appears correct and doesn't need changes
- All issues are with the build/configuration, not the test code
- The `comprehensiveDebugWithBuildCapture` command is working correctly and capturing build errors as designed
- Focus should be on fixing the Vite/build configuration to get the dev server running

## üîç Root Cause Summary

The primary issue is that the Vite dev server cannot start due to:

1. Configuration conflicts (duplicate keys)
2. Missing or incorrectly referenced dependencies
3. Incompatibility with React Native's Flow type syntax
4. Babel transformation issues

Once these are resolved, the Cypress tests should be able to connect to the dev server and execute successfully.
